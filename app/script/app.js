// Generated by CoffeeScript 1.6.1
(function() {
  var all, buildArrow, canvas, graph, vectors;

  all = {
    text: ""
  };

  graph = {};

  vectors = [];

  canvas = {};

  window.getCanvas = function() {
    return canvas;
  };

  $(document).ready(function() {
    var build, initialize, overlay;
    overlay = $("#overlay");
    canvas = Raphael(overlay.get(0));
    build = function(graph) {
      var id, vertex, _i, _len;
      for (vertex = _i = 0, _len = graph.length; _i < _len; vertex = ++_i) {
        id = graph[vertex];
        graph[vertex.parent].children.push(id);
      }
      return chrome.tabs.query({}, function(tabs) {
        var current, key, tab, _j, _len1, _results;
        _results = [];
        for (_j = 0, _len1 = tabs.length; _j < _len1; _j++) {
          tab = tabs[_j];
          current = {
            time: 0
          };
          for (key in graph) {
            vertex = graph[key];
            if (vertex.url === tab.url) {
              if (vertex.time > current["time"]) {
                current = vertex;
                current.key = key;
              }
            }
          }
          _results.push(CreateVector(current));
        }
        return _results;
      });
    };
    initialize = function(history) {
      var makeGraph, visit;
      graph = {};
      makeGraph = function(visits, link) {
        var visit, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = visits.length; _i < _len; _i++) {
          visit = visits[_i];
          _results.push(graph[visit.visitId] = {
            url: link.url,
            title: link.title,
            time: link.lastVisitTime,
            parent: visit.referringVisitId,
            children: []
          });
        }
        return _results;
      };
      visit = function(history) {
        return async.map(history, (function(link, callback) {
          return chrome.history.getVisits({
            'url': link.url
          }, function(visits) {
            makeGraph(visits, link);
            return callback(null, true);
          });
        }), function(err, results) {
          return build(graph);
        });
      };
      return visit(history);
    };
    return chrome.history.search(all, function(history) {
      return initialize(history);
    });
  });

  window.CreateVector = function(vertex) {
    var $vector, left, recurse;
    left = vectors.length * 212;
    $vector = $("<div/>", {
      "class": 'vector',
      style: "left: " + left + "px; top: 60px;"
    });
    $("#overlay").append($vector);
    recurse = function(vertex) {
      var child, _i, _len, _ref;
      $vector.append(BuildDiv(vertex.time, vertex.title, vertex.url));
      _ref = vertex.children;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        buildArrow($vertex, $("#" + graph[child]));
      }
      if ((graph[vertex.parent] != null) && vertex.parent !== '0') {
        return recurse(graph[vertex.parent]);
      }
    };
    recurse(vertex);
    return vectors.push($vector);
  };

  window.BuildDiv = function(bottomTime, title, url) {
    var $a, $div;
    $div = $("<div/>", {
      "class": "fading link",
      id: url,
      text: title
    });
    return $a = $("<a/>", {
      href: url
    }).append($div);
  };

  buildArrow = function(from, to) {};

}).call(this);
